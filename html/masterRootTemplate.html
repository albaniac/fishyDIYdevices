<!--------------------------------------------------------------------------------------------------------
This is the template file for the master web site (stored in webresources.h in parts). It relies on jquery 
(stored in googleapis - but requires iternet access as written). It also relies on styles.css (which is embedded
into code - see that file for its instructions).
You also need to embedd "fishyDIYnode.html", and "fishyDIYgroup.html" into the webresources.h for handling individual
or group processing (specific to each type of device).
To build it in the code do the following:
 1) Copy the first block (PART 1).
 2) put it through a minifier (like https://kangax.github.io/html-minifier/) and then through a String builder
 (like http://buildmystring.com/ with "strip out carriage returns" on) to create a single string with no tabs and one line.
 3) paste that into the WEBROOTSTRPT1 after "PROGMEM" in the webresources.h file.
 4) copy the second block (from below the JSON definition to the end).
 5) repeat steps 2 and 3 putting the result in WEBROOTSTRPT2 after "PROGMEM"
 ------------------------------------------------------------------------------------------------------->

<!-------------------------------------------------------------------------------------------------------
 ----------------------------------- START OF PART 1 (HEADER): ------------------------------------------
 ------------------------------------------------------------------------------------------------------->
<!DOCTYPE html>
<html>
<head>
    <title>fishDIY Device Network</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
   
<!------------------------------------------------------------------------------------------------------
--------END OF PART 1:  Do not copy the following lines - these are handled within the code. -----------
------------------------------------------------------------------------------------------------------->
    <link rel="stylesheet" href="styles.css">     
    <script>
            var fishyNetJSON ='{"fishyDevices":[{"ip":"10.203.1.197","name":"Test Actuator 1","dead":"0","typestr":"limit sw actuator","groupstr":"test group 1","statusstr":"80% Open","inError":"false","isMaster":"true"},{"ip":"10.203.1.123","name":"Test Actuator 2","dead":"0","typestr":"limit sw actuator","groupstr":"test group 1","statusstr":"Open","inError":"false","isMaster":"false"},{"ip":"10.203.1.145","name":"Test Actuator 3","dead":"0","typestr":"limit sw actuator","groupstr":"test group 1","statusstr":"Closed","inError":"false","isMaster":"false"},{"ip":"10.203.1.127","name":"Test Actuator 4","dead":"0","typestr":"limit sw actuator","groupstr":"test group 1","statusstr":"On","inError":"true","isMaster":"false"}]}';
    </script>
<!------------------------------------------------------------------------------------------------------
----------------------------------  START OF PART 2    -------------------------------------------------
------------------------------------------------------------------------------------------------------->
</head>
<body><div class='main' id='myBody'>   
    <script>

        function addDevice(d){
            var addDiv = "<div class='CPdevice' id='CP-" + d.ip + "'>";
            addDiv += addInnerDevice(d);
            addDiv += "</div>";      
            return addDiv;
        }
        
        function addInnerDevice(d){
            var errTxt;
            if (d.inError == 'true') { errTxt = 'CPhdErr'; } else { errTxt = 'CPhdErrClear'; }
            var mstrTxt;
            if (d.isMaster == 'true') { mstrTxt = 'MASTER:'+d.ip; } else { mstrTxt = d.ip; }
            var addDiv = "<div class='CPhd' id='hd1-" + d.ip + "'>" + d.name + "</div>";
            if(isCtrl){
                addDiv += "<div id='CPerr-" + d.ip + "' class='" + errTxt + "'>ERROR</div>";
                addDiv += "<div >" + d.statusstr + "</div>";
                addDiv += "<button id='myBtn-'+ ii +'>Open Controls</button>";
                addDiv += "<div>Group:" + d.groupstr + "</div>";
                addDiv += "<div>Type:" + d.typestr + "</div>";
            }
            else
            {
                addDiv += "<iframe id='swUpdate-" + d.ip + "' class='swUpdate' src='http://"+d.ip+"/SWupdateDevForm' ></iframe><br>";
            }
            addDiv += "<div class='CPft' id='CPft-" + d.ip + "'>"+mstrTxt+"</div>";
            return addDiv;
        }

        function refreshToggle(){
            var label = document.getElementById('swRefreshLab-1');
            var sw = document.getElementById('swRefreshChck-1');
            if (sw.checked == true) { 
                label.innerHTML = 'Auto-refresh On';
                pollTimer = setInterval(function () {
                    pollJSON();
                }, 10000);
            } else { 
                label.innerHTML = 'Auto-refresh Off'; 
                clearInterval(pollTimer);
            }
        }
        
        function loadJSON(path, success, error)
            {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function()
            {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success)
                            success(JSON.parse(xhr.responseText));
                    } else {
                        if (error)
                            error(xhr);
                    }
                }
            };
            xhr.open("GET", path, true);
            xhr.send();
        }

        function pollJSON() {
            var srcStr = './network.JSON?nocache=' + (new Date()).getTime();
            loadJSON(srcStr, 
                //load success function
                function (data) {
                    var DA = data.fishyDevices;
                    var addDiv = '';
                    var mstrTxt = '&nbsp;';
                    var errTxt = 'none';
                    var cpnode;
                    Array.prototype.forEach.call(DA, 
                        function (d,num) {
                            cpnode=document.getElementById('CP-'+d.ip);
                            if (d.dead == '0') {
                                //look for new devices in the JSON
                                if(cpnode==null){
                                    var newDiv = document.createElement("DIV");
                                    newDiv.id='CP-'+d.ip;
                                    newDiv.className = 'CPdevice';
                                    cpnode = document.getElementById('flex-container').appendChild(newDiv);
                                }
                                cpnode.innerHTML = addInnerDevice(d);    
                            }else{
                                if(cpnode!=null){
                                    document.getElementById('flex-container').removeChild(cpnode);
                                }    
                            }
                        }
                    );
                    var gone;
                    var elements = document.querySelectorAll('.CPdevice');
                    Array.prototype.forEach.call(elements, 
                        function(e, num){
                            gone = true;
                            Array.prototype.forEach.call(DA, 
                                function (d,num) {
                                    if((('CP-' + d.ip) == e.id) && (d.dead == 0)) gone=false;
                                }
                            );
                            if(gone){
                                document.getElementById('flex-container').removeChild(e);
                            }
                        }
                    );
                    console.log( "loadJSON and page update success");
                },
                //load failure function
                function(xhr){
                    console.log("Error with loadJSON")
                }
            );
        }

        var isCtrl = true;
        function buildPage() {
             var data = JSON.parse(fishyNetJSON);
             var DA = data.fishyDevices;
             var items = [];
             var addDiv = '';
             var ii;
             var theBody = document.getElementById('myBody');
             var newdiv = document.createElement('DIV');
             newdiv.className = 'fishyHdr';
             theBody.appendChild(newdiv);
             if (location.pathname.slice(1,4) == "SWu"){ 
                 isCtrl = false; //the page is a SW update page
                 newdiv.innerHTML = 'fishyDevice Software Update';
             }else{
                newdiv.innerHTML = 'fishyDevice Controls';
             }
             newdiv = document.createElement('DIV');
             newdiv.className = 'CPhd3';
             theBody.appendChild(newdiv);
             if(isCtrl){
                 newdiv.innerHTML = "<span class='swRow'><label class='sw' id='swRefresh-1'><input type='checkbox' checked id='swRefreshChck-1' onchange=refreshToggle()><span class='sldSw'></span></label><span class='swLabHdr' id='swRefreshLab-1'>Auto-refresh On</span></span>";
             }
            //TODO - make a funtion to parse the group names, and then make a group iframe
             
            Array.prototype.forEach.call(DA, 
                function (d,num) {
                    items.push(addDevice(d));
                }
            );
            newdiv = document.createElement('DIV');
            newdiv.className = 'flex-container';
            newdiv.id = 'flex-container';
            newdiv.innerHTML = items.join('');
            theBody.appendChild(newdiv);
                         
         }
        window.onload = buildPage();
        var pollTimer;
        if(isCtrl){
            if(document.getElementById('swRefreshChck-1').checked){
                pollTimer = setInterval(function () {
                    pollJSON();
                }, 10000);
            }
        }

     </script>
     
     <div class='fishyFtr'><a href="/">[Controls]</a>  <a href="/SWupdater">[SW Update]</a></div></div>
 </body>
 </html>
<!------------------------------------------------------------------------------------------------------
---------------------------------------------- END OF PART 2 -------------------------------------------
------------------------------------------------------------------------------------------------------->